"use strict";const t=require("../../common/vendor.js"),e=require("../../common/api/login.js"),o=require("../../common/api/wechat.js"),a=require("./zujian/u-charts.js"),s={data(){return{startDate:this.getLastMonthDate(),endDate:this.getCurrentDate(),records:[],loading:!1,page:1,pageSize:20,total:0,hasMore:!1,cWidth:0,cHeight:0,pixelRatio:1,glucoseChart:null,isDatePickerOpen:!1}},computed:{hasRecords(){return this.records&&this.records.length>0}},methods:{getCurrentDate(){const t=new Date;return`${t.getFullYear()}-${(t.getMonth()+1).toString().padStart(2,"0")}-${t.getDate().toString().padStart(2,"0")}`},getLastMonthDate(){const t=new Date;t.setMonth(t.getMonth()-1);return`${t.getFullYear()}-${(t.getMonth()+1).toString().padStart(2,"0")}-${t.getDate().toString().padStart(2,"0")}`},formatShortDate(t){if(!t)return"";const e=new Date(t);return`${(e.getMonth()+1).toString().padStart(2,"0")}-${e.getDate().toString().padStart(2,"0")}`},loadRecordsFromCloud(){this.loading=!0;const a=o.getWechatLoginState();if(!a.isLoggedIn)return t.index.showToast({title:"您尚未登录",icon:"none"}),void setTimeout((()=>{e.checkLoginAndRedirect()}),1500);t.nr.callFunction({name:"glucose-service",data:{action:"list",params:{userId:a.userInfo._id||a.openid,startDate:this.startDate,endDate:this.endDate,page:this.page,pageSize:this.pageSize}}}).then((e=>{if(this.loading=!1,t.index.hideLoading(),e.result&&0===e.result.code){const o=(e.result.data.list||[]).map((t=>{console.log("原始记录数据:",t);const e=void 0!==t.fastingGlucose?t.fastingGlucose:void 0!==t.fasting_glucose?t.fasting_glucose:void 0,o=void 0!==t.postprandialGlucose?t.postprandialGlucose:void 0!==t.postprandial_glucose?t.postprandial_glucose:void 0,a=void 0!==t.bloodPressure?t.bloodPressure:void 0!==t.blood_pressure?t.blood_pressure:void 0;return{id:t._id,date:this.formatShortDate(t.date),fastingGlucose:void 0!==e?parseFloat(e).toFixed(1):"-",postprandialGlucose:void 0!==o?parseFloat(o).toFixed(1):"-",bloodPressure:a||"-"}}));1===this.page?(this.records=o,o.length>0&&!this.isDatePickerOpen&&this.drawGlucoseChart()):this.records=[...this.records,...o],this.total=e.result.data.total||0,this.hasMore=this.records.length<this.total,0===this.records.length&&t.index.showToast({title:"暂无记录",icon:"none"})}else t.index.showToast({title:e.result&&e.result.message||"获取记录失败",icon:"none"})})).catch((e=>{this.loading=!1,t.index.hideLoading(),t.index.showToast({title:"网络错误，请稍后重试",icon:"none"}),console.error("获取血糖记录失败",e)}))},searchRecords(){this.page=1,this.loading||t.index.showLoading({title:"加载中..."}),this.isDatePickerOpen=!1,this.loadRecordsFromCloud()},loadMore(){!this.loading&&this.hasMore&&(this.page++,this.loadRecordsFromCloud())},drawGlucoseChart(){try{if(!this.records||0===this.records.length)return void console.log("没有足够的数据来绘制图表");const e=[...this.records].reverse().slice(0,7),o=e.map((t=>t.date)),s=e.map((t=>t.fastingGlucose&&"-"!==t.fastingGlucose?parseFloat(t.fastingGlucose):null)),i=e.map((t=>t.postprandialGlucose&&"-"!==t.postprandialGlucose?parseFloat(t.postprandialGlucose):null));console.log("图表数据:",{categories:o,fastingData:s,postprandialData:i});const r=[...s,...i].filter((t=>null!==t&&!isNaN(t)));if(0===r.length)return void console.log("没有有效的数据点");const n=Math.min(...r),l=Math.max(...r),c=Math.max(l-n,1),h=Math.max(0,n-.2*c),d=l+.2*c,u=t.index.createCanvasContext("glucoseChart",this);this.cWidth=Math.max(this.cWidth,300),this.cHeight=Math.max(this.cHeight,280);const g={$this:this,canvasId:"glucoseChart",type:"line",categories:o,series:[{name:"空腹血糖",data:s,color:"#4095E5",pointShape:"circle",pointStyle:"fill",pointSize:8,format:t=>null===t||isNaN(t)?"-":t.toFixed(1)},{name:"餐后血糖",data:i,color:"#FF6B6B",pointShape:"circle",pointStyle:"fill",pointSize:8,format:t=>null===t||isNaN(t)?"-":t.toFixed(1)}],width:this.cWidth,height:this.cHeight,pixelRatio:this.pixelRatio,animation:!1,background:"#FFFFFF",padding:[30,15,50,20],dataLabel:!0,dataPointShape:!0,enableScroll:!1,legend:{show:!1},xAxis:{type:"category",boundaryGap:!1,disableGrid:!0,fontColor:"#666666",fontSize:10,itemCount:o.length,axisLine:!0,margin:3},yAxis:{position:"left",type:"value",disabled:!1,disableGrid:!1,splitNumber:5,gridType:"dash",gridColor:"#CCCCCC",min:h,max:d,format:t=>null===t||isNaN(t)?"-":t.toFixed(1),axisLine:!0,fontColor:"#666666",fontSize:10,title:"血糖值",titleFontColor:"#666666",width:10},extra:{line:{type:"straight",width:3,activeType:"hollow",activeColor:"#000000",activeRadius:10},tooltip:{showBox:!0,showArrow:!0,borderWidth:1,borderRadius:3,borderColor:"#CCCCCC",bgColor:"#FFFFFF",fontColor:"#666666",fontSize:12}},context:u};u.setFillStyle("#FFFFFF"),u.fillRect(0,0,this.cWidth,this.cHeight),this.glucoseChart=new a.uCharts(g),u.draw(!0,(()=>{console.log("Canvas绘制完成"),setTimeout((()=>{if(this.glucoseChart)try{console.log("执行更新..."),this.glucoseChart=new a.uCharts(g),u.draw(!0)}catch(t){console.error("更新图表失败",t)}}),200)}))}catch(e){console.error("绘制图表过程中出错",e),t.index.showToast({title:"图表绘制失败",icon:"none"})}},touchstart(t){try{this.glucoseChart&&(this.glucoseChart.touchLegend(t),this.glucoseChart.showToolTip(t,{format:function(t,e){return null===t.data||isNaN(t.data)?e+" "+t.name+": 无数据":e+" "+t.name+": "+t.data+" mmol/L"},fontSize:13,lineHeight:22}))}catch(e){console.error("处理触摸事件失败",e)}},touchmove(t){try{this.glucoseChart&&this.glucoseChart.showToolTip(t,{format:function(t,e){return null===t.data||isNaN(t.data)?e+" "+t.name+": 无数据":e+" "+t.name+": "+t.data+" mmol/L"},fontSize:13,lineHeight:22})}catch(e){console.error("处理移动事件失败",e)}},touchend(t){try{this.glucoseChart&&this.glucoseChart.touchLegend(t)}catch(e){console.error("处理触摸结束事件失败",e)}},onDateChange(t){console.log("日期变更:",t),this.isDatePickerOpen=!1,setTimeout((()=>{this.hasRecords&&this.drawGlucoseChart()}),300)},onMaskClick(){console.log("遮罩点击"),this.isDatePickerOpen=!1,setTimeout((()=>{this.hasRecords&&this.drawGlucoseChart()}),300)},onDatePickerClick(){console.log("点击日期选择器"),this.isDatePickerOpen=!0}},onLoad(){console.log("onLoad"),e.checkLoginAndRedirect()&&this.loadRecordsFromCloud()},onShow(){console.log("onShow"),e.checkLoginAndRedirect()&&(this.page=1,this.loadRecordsFromCloud())},onReady(){setTimeout((()=>{this.hasRecords&&(console.log("onReady开始绘制图表"),this.drawGlucoseChart())}),300)},onPullDownRefresh(){this.page=1,this.loadRecordsFromCloud(),setTimeout((()=>{t.index.stopPullDownRefresh()}),1e3)},onReachBottom(){this.loadMore()}};if(!Array){t.resolveComponent("uni-datetime-picker")()}Math;const i=t._export_sfc(s,[["render",function(e,o,a,s,i,r){return t.e({a:t.o(r.onDateChange),b:t.o(r.onMaskClick),c:t.o((t=>i.startDate=t)),d:t.p({type:"date",modelValue:i.startDate}),e:t.o(((...t)=>r.onDatePickerClick&&r.onDatePickerClick(...t))),f:t.o(r.onDateChange),g:t.o(r.onMaskClick),h:t.o((t=>i.endDate=t)),i:t.p({type:"date",modelValue:i.endDate}),j:t.o(((...t)=>r.onDatePickerClick&&r.onDatePickerClick(...t))),k:t.o(((...t)=>r.searchRecords&&r.searchRecords(...t))),l:r.hasRecords&&!i.isDatePickerOpen},r.hasRecords&&!i.isDatePickerOpen?{m:t.o(((...t)=>r.touchstart&&r.touchstart(...t))),n:t.o(((...t)=>r.touchmove&&r.touchmove(...t))),o:t.o(((...t)=>r.touchend&&r.touchend(...t)))}:{},{p:!r.hasRecords},r.hasRecords?{q:t.f(i.records,((e,o,a)=>({a:t.t(e.date),b:t.t(e.fastingGlucose),c:t.t(e.postprandialGlucose),d:t.t(e.bloodPressure),e:o})))}:{})}]]);wx.createPage(i);
