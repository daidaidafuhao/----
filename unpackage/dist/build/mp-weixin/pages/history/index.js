"use strict";const t=require("../../common/vendor.js"),e=require("../../common/api/login.js"),o=require("../../common/api/wechat.js"),a=require("./zujian/u-charts.js"),s={data(){return{startDate:this.getLastMonthDate(),endDate:this.getCurrentDate(),records:[],loading:!1,page:1,pageSize:20,total:0,hasMore:!1,cWidth:0,cHeight:0,pixelRatio:1,glucoseChart:null}},computed:{hasRecords(){return this.records&&this.records.length>0}},methods:{getCurrentDate(){const t=new Date;return`${t.getFullYear()}-${(t.getMonth()+1).toString().padStart(2,"0")}-${t.getDate().toString().padStart(2,"0")}`},getLastMonthDate(){const t=new Date;t.setMonth(t.getMonth()-1);return`${t.getFullYear()}-${(t.getMonth()+1).toString().padStart(2,"0")}-${t.getDate().toString().padStart(2,"0")}`},formatShortDate(t){if(!t)return"";const e=new Date(t);return`${(e.getMonth()+1).toString().padStart(2,"0")}-${e.getDate().toString().padStart(2,"0")}`},loadRecordsFromCloud(){this.loading=!0;const a=o.getWechatLoginState();if(!a.isLoggedIn)return t.index.showToast({title:"您尚未登录",icon:"none"}),void setTimeout((()=>{e.checkLoginAndRedirect()}),1500);t.nr.callFunction({name:"glucose-service",data:{action:"list",params:{userId:a.userInfo._id||a.openid,startDate:this.startDate,endDate:this.endDate,page:this.page,pageSize:this.pageSize}}}).then((e=>{if(this.loading=!1,e.result&&0===e.result.code){const o=(e.result.data.list||[]).map((t=>({id:t._id,date:this.formatShortDate(t.date),fastingGlucose:t.fasting_glucose.toFixed(1),postprandialGlucose:t.postprandial_glucose.toFixed(1)})));1===this.page?(this.records=o,o.length>0&&this.drawGlucoseChart()):this.records=[...this.records,...o],this.total=e.result.data.total||0,this.hasMore=this.records.length<this.total,0===this.records.length&&t.index.showToast({title:"暂无记录",icon:"none"})}else t.index.showToast({title:e.result&&e.result.message||"获取记录失败",icon:"none"})})).catch((e=>{this.loading=!1,t.index.showToast({title:"网络错误，请稍后重试",icon:"none"}),console.error("获取血糖记录失败",e)}))},searchRecords(){this.page=1,this.loadRecordsFromCloud()},loadMore(){!this.loading&&this.hasMore&&(this.page++,this.loadRecordsFromCloud())},drawGlucoseChart(){try{if(!this.records||0===this.records.length)return void console.log("没有足够的数据来绘制图表");const e=[...this.records].reverse().slice(0,7),o=e.map((t=>t.date)),s=e.map((t=>parseFloat(t.fastingGlucose))),i=e.map((t=>parseFloat(t.postprandialGlucose)));console.log("图表数据:",{categories:o,fastingData:s,postprandialData:i});const r=[...s,...i].filter((t=>!isNaN(t)));if(0===r.length)return void console.log("没有有效的数据点");const n=Math.min(...r),h=Math.max(...r),c=Math.max(h-n,1),l=Math.max(0,n-.2*c),d=h+.2*c,g=t.index.createCanvasContext("glucoseChart",this);this.cWidth=Math.max(this.cWidth,300),this.cHeight=Math.max(this.cHeight,280);const u={$this:this,canvasId:"glucoseChart",type:"line",categories:o,series:[{name:"空腹血糖",data:s,color:"#4095E5",pointShape:"circle",pointStyle:"fill",pointSize:8,format:t=>t.toFixed(1)},{name:"餐后血糖",data:i,color:"#FF6B6B",pointShape:"circle",pointStyle:"fill",pointSize:8,format:t=>t.toFixed(1)}],width:this.cWidth,height:this.cHeight,pixelRatio:this.pixelRatio,animation:!1,background:"#FFFFFF",padding:[30,15,50,20],dataLabel:!0,dataPointShape:!0,enableScroll:!1,legend:{show:!1},xAxis:{type:"category",boundaryGap:!1,disableGrid:!0,fontColor:"#666666",fontSize:10,itemCount:o.length,axisLine:!0,margin:3},yAxis:{position:"left",type:"value",disabled:!1,disableGrid:!1,splitNumber:5,gridType:"dash",gridColor:"#CCCCCC",min:l,max:d,format:t=>t.toFixed(1),axisLine:!0,fontColor:"#666666",fontSize:10,title:"血糖值",titleFontColor:"#666666",width:10},extra:{line:{type:"straight",width:3,activeType:"hollow",activeColor:"#000000",activeRadius:10},tooltip:{showBox:!0,showArrow:!0,borderWidth:1,borderRadius:3,borderColor:"#CCCCCC",bgColor:"#FFFFFF",fontColor:"#666666",fontSize:12}},context:g};g.setFillStyle("#FFFFFF"),g.fillRect(0,0,this.cWidth,this.cHeight),this.glucoseChart=new a.uCharts(u),g.draw(!0,(()=>{console.log("Canvas绘制完成"),setTimeout((()=>{if(this.glucoseChart)try{console.log("执行更新..."),this.glucoseChart=new a.uCharts(u),g.draw(!0)}catch(t){console.error("更新图表失败",t)}}),200)}))}catch(e){console.error("绘制图表过程中出错",e),t.index.showToast({title:"图表绘制失败",icon:"none"})}},touchstart(t){try{this.glucoseChart&&(this.glucoseChart.touchLegend(t),this.glucoseChart.showToolTip(t,{format:function(t,e){return e+" "+t.name+": "+t.data+" mmol/L"},fontSize:13,lineHeight:22}))}catch(e){console.error("处理触摸事件失败",e)}},touchmove(t){try{this.glucoseChart&&this.glucoseChart.showToolTip(t,{format:function(t,e){return e+" "+t.name+": "+t.data+" mmol/L"},fontSize:13,lineHeight:22})}catch(e){console.error("处理移动事件失败",e)}},touchend(t){try{this.glucoseChart&&this.glucoseChart.touchLegend(t)}catch(e){console.error("处理触摸结束事件失败",e)}}},onLoad(){console.log("onLoad"),e.checkLoginAndRedirect()&&this.loadRecordsFromCloud()},onShow(){console.log("onShow"),e.checkLoginAndRedirect()},onReady(){setTimeout((()=>{this.hasRecords&&(console.log("onReady开始绘制图表"),this.drawGlucoseChart())}),300)},onPullDownRefresh(){this.page=1,this.loadRecordsFromCloud(),setTimeout((()=>{t.index.stopPullDownRefresh()}),1e3)},onReachBottom(){this.loadMore()}};if(!Array){t.resolveComponent("uni-datetime-picker")()}Math;const i=t._export_sfc(s,[["render",function(e,o,a,s,i,r){return t.e({a:t.o((t=>i.startDate=t)),b:t.p({type:"date",modelValue:i.startDate}),c:t.o((t=>i.endDate=t)),d:t.p({type:"date",modelValue:i.endDate}),e:t.o(((...t)=>r.searchRecords&&r.searchRecords(...t))),f:r.hasRecords},r.hasRecords?{g:t.o(((...t)=>r.touchstart&&r.touchstart(...t))),h:t.o(((...t)=>r.touchmove&&r.touchmove(...t))),i:t.o(((...t)=>r.touchend&&r.touchend(...t)))}:{},{j:!r.hasRecords},r.hasRecords?{k:t.f(i.records,((e,o,a)=>({a:t.t(e.date),b:t.t(e.fastingGlucose),c:t.t(e.postprandialGlucose),d:o})))}:{})}]]);wx.createPage(i);
