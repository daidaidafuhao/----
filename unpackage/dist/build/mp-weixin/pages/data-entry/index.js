"use strict";const e=require("../../common/vendor.js"),t=require("../../common/api/login.js"),s=require("../../common/api/wechat.js"),o={data(){return{formData:{date:this.getCurrentDate(),fastingGlucose:"",postprandialGlucose:"",bloodPressure:""},glucoseErrors:{fastingGlucose:"",postprandialGlucose:""},rules:{date:{rules:[]},fastingGlucose:{rules:[]},postprandialGlucose:{rules:[]}},isNarrowScreen:!1,existingRecord:null,recordId:null}},computed:{canSubmit(){return this.formData.date&&(this.formData.fastingGlucose||this.formData.postprandialGlucose||this.existingRecord&&(this.existingRecord.fastingGlucose||this.existingRecord.postprandialGlucose))},submitButtonText(){return this.existingRecord?"更新记录":"提交"}},onLoad(){t.checkLoginAndRedirect()&&(this.checkScreenWidth(),this.checkExistingRecord())},onShow(){t.checkLoginAndRedirect()&&this.checkExistingRecord()},methods:{getRecordInfoText(){let e="当前日期已有记录: ";return this.existingRecord.fastingGlucose&&this.existingRecord.postprandialGlucose?e+=`空腹 ${this.existingRecord.fastingGlucose}mmol/L，餐后 ${this.existingRecord.postprandialGlucose}mmol/L`:this.existingRecord.fastingGlucose?e+=`空腹 ${this.existingRecord.fastingGlucose}mmol/L`:this.existingRecord.postprandialGlucose&&(e+=`餐后 ${this.existingRecord.postprandialGlucose}mmol/L`),e},checkExistingRecord(){const t=s.getWechatLoginState();t.isLoggedIn&&(this.existingRecord=null,this.recordId=null,e.index.showLoading({title:"查询记录..."}),e.nr.callFunction({name:"glucose-service",data:{action:"getByDate",params:{userId:t.userInfo._id||t.openid,date:this.formData.date}}}).then((t=>{e.index.hideLoading(),t.result&&0===t.result.code&&t.result.data?(this.existingRecord=t.result.data,this.recordId=t.result.data._id,!this.formData.fastingGlucose&&this.existingRecord.fastingGlucose&&(this.formData.fastingGlucose=this.existingRecord.fastingGlucose),!this.formData.postprandialGlucose&&this.existingRecord.postprandialGlucose&&(this.formData.postprandialGlucose=this.existingRecord.postprandialGlucose),!this.formData.bloodPressure&&this.existingRecord.bloodPressure&&(this.formData.bloodPressure=this.existingRecord.bloodPressure)):(this.existingRecord=null,this.recordId=null)})).catch((t=>{e.index.hideLoading(),console.error("查询记录失败",t)})))},checkScreenWidth(){const t=e.index.getSystemInfoSync();this.isNarrowScreen=t.windowWidth<600},getCurrentDate(){const e=new Date;return`${e.getFullYear()}-${(e.getMonth()+1).toString().padStart(2,"0")}-${e.getDate().toString().padStart(2,"0")}`},changeDate(e){const t=new Date(this.formData.date);t.setDate(t.getDate()+e);const s=t.getFullYear(),o=(t.getMonth()+1).toString().padStart(2,"0"),i=t.getDate().toString().padStart(2,"0");this.formData.date=`${s}-${o}-${i}`,this.checkExistingRecord()},validateGlucose(e){const t=parseFloat(this.formData[e]);this.glucoseErrors[e]="",this.formData[e]&&(isNaN(t)?this.glucoseErrors[e]="请输入有效数值":("fastingGlucose"===e&&(t<3?this.glucoseErrors[e]="血糖值过低，请确认是否正确":t>7&&(this.glucoseErrors[e]="血糖值偏高，请注意控制")),"postprandialGlucose"===e&&(t<3?this.glucoseErrors[e]="血糖值过低，请确认是否正确":t>11.1?this.glucoseErrors[e]="血糖值过高，请及时就医":t>7.8&&(this.glucoseErrors[e]="血糖值偏高，请注意控制"))))},submitForm(){if(!this.canSubmit)return;if(!this.formData.fastingGlucose&&!this.formData.postprandialGlucose&&!this.existingRecord)return void e.index.showToast({title:"请至少填写一项血糖值",icon:"none"});this.formData.fastingGlucose&&this.validateGlucose("fastingGlucose"),this.formData.postprandialGlucose&&this.validateGlucose("postprandialGlucose"),(this.glucoseErrors.fastingGlucose||this.glucoseErrors.postprandialGlucose)&&e.index.showToast({title:"血糖值异常，但仍可提交",icon:"none",duration:2e3}),e.index.showLoading({title:this.existingRecord?"更新中...":"提交中..."});const o=s.getWechatLoginState();if(!o.isLoggedIn)return e.index.hideLoading(),e.index.showToast({title:"您尚未登录",icon:"none"}),void setTimeout((()=>{t.checkLoginAndRedirect()}),1500);const i={userId:o.userInfo._id||o.openid,date:this.formData.date,bloodPressure:this.formData.bloodPressure||this.existingRecord&&this.existingRecord.bloodPressure||""};this.formData.fastingGlucose?i.fastingGlucose=this.formData.fastingGlucose:this.existingRecord&&this.existingRecord.fastingGlucose&&(i.fastingGlucose=this.existingRecord.fastingGlucose),this.formData.postprandialGlucose?i.postprandialGlucose=this.formData.postprandialGlucose:this.existingRecord&&this.existingRecord.postprandialGlucose&&(i.postprandialGlucose=this.existingRecord.postprandialGlucose);const r=this.existingRecord?"update":"add";"update"===r&&(i.recordId=this.recordId),e.nr.callFunction({name:"glucose-service",data:{action:r,params:i}}).then((t=>{e.index.hideLoading(),t.result&&0===t.result.code?(e.index.showToast({title:t.result.message||("update"===r?"更新成功":"提交成功"),icon:"success"}),"add"===r?(this.recordId=t.result.data&&t.result.data.id,this.existingRecord={...i,_id:this.recordId}):this.existingRecord={...this.existingRecord,...i}):e.index.showToast({title:t.result&&t.result.message||"提交失败",icon:"none"})})).catch((t=>{e.index.hideLoading(),e.index.showToast({title:"网络错误，请稍后重试",icon:"none"}),console.error("提交血糖数据失败",t)}))}}};if(!Array){(e.resolveComponent("uni-icons")+e.resolveComponent("uni-datetime-picker")+e.resolveComponent("uni-forms-item")+e.resolveComponent("uni-easyinput")+e.resolveComponent("uni-forms"))()}Math||((()=>"../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+(()=>"../../uni_modules/uni-datetime-picker/components/uni-datetime-picker/uni-datetime-picker.js")+(()=>"../../uni_modules/uni-forms/components/uni-forms-item/uni-forms-item.js")+(()=>"../../uni_modules/uni-easyinput/components/uni-easyinput/uni-easyinput.js")+(()=>"../../uni_modules/uni-forms/components/uni-forms/uni-forms.js"))();const i=e._export_sfc(o,[["render",function(t,s,o,i,r,a){return e.e({a:e.o((e=>a.changeDate(-1))),b:e.p({type:"left",size:"20",color:"#666"}),c:e.o(a.checkExistingRecord),d:e.o((e=>r.formData.date=e)),e:e.p({type:"date",modelValue:r.formData.date}),f:e.o((e=>a.changeDate(1))),g:e.p({type:"right",size:"20",color:"#666"}),h:e.p({label:"日期"}),i:r.isNarrowScreen?1:"",j:e.o((e=>a.validateGlucose("fastingGlucose"))),k:e.o((e=>r.formData.fastingGlucose=e)),l:e.p({type:"digit",placeholder:"请输入","input-border":!1,modelValue:r.formData.fastingGlucose}),m:r.glucoseErrors.fastingGlucose},r.glucoseErrors.fastingGlucose?{n:e.t(r.glucoseErrors.fastingGlucose)}:{},{o:e.p({label:"空腹血糖值"}),p:r.isNarrowScreen?1:"",q:e.o((e=>a.validateGlucose("postprandialGlucose"))),r:e.o((e=>r.formData.postprandialGlucose=e)),s:e.p({type:"digit",placeholder:"请输入","input-border":!1,modelValue:r.formData.postprandialGlucose}),t:r.glucoseErrors.postprandialGlucose},r.glucoseErrors.postprandialGlucose?{v:e.t(r.glucoseErrors.postprandialGlucose)}:{},{w:!r.formData.postprandialGlucose&&r.formData.fastingGlucose},(!r.formData.postprandialGlucose&&r.formData.fastingGlucose,{}),{x:e.p({label:"餐后两小时血糖值"}),y:r.isNarrowScreen?1:"",z:e.o((e=>r.formData.bloodPressure=e)),A:e.p({type:"text",placeholder:"请输入(例如:120/80)","input-border":!1,modelValue:r.formData.bloodPressure}),B:e.p({label:"血压"}),C:r.isNarrowScreen?1:"",D:e.t(a.submitButtonText),E:a.canSubmit?"primary":"default",F:e.o(((...e)=>a.submitForm&&a.submitForm(...e))),G:!a.canSubmit,H:a.canSubmit?"":1,I:a.canSubmit?1:"",J:r.existingRecord},r.existingRecord?{K:e.t(a.getRecordInfoText())}:{},{L:e.sr("form","26578643-0"),M:e.p({modelValue:r.formData,rules:r.rules,validateTrigger:"bind"})})}]]);wx.createPage(i);
