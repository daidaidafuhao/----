"use strict";const e=require("../../common/vendor.js"),o=require("../../common/api/login.js"),t=require("../../common/api/wechat.js"),s={data(){return{formData:{date:this.getCurrentDate(),fastingGlucose:"",postprandialGlucose:""},glucoseErrors:{fastingGlucose:"",postprandialGlucose:""},rules:{date:{rules:[{required:!0,errorMessage:"请选择日期"}]},fastingGlucose:{rules:[{required:!0,errorMessage:"请输入空腹血糖值"}]},postprandialGlucose:{rules:[{required:!0,errorMessage:"请输入餐后两小时血糖值"}]}},isNarrowScreen:!1}},computed:{isFormValid(){return this.formData.date&&this.formData.fastingGlucose&&this.formData.postprandialGlucose}},onLoad(){o.checkLoginAndRedirect()&&this.checkScreenWidth()},onShow(){o.checkLoginAndRedirect()},methods:{checkScreenWidth(){const o=e.index.getSystemInfoSync();this.isNarrowScreen=o.windowWidth<600},getCurrentDate(){const e=new Date;return`${e.getFullYear()}-${(e.getMonth()+1).toString().padStart(2,"0")}-${e.getDate().toString().padStart(2,"0")}`},changeDate(e){const o=new Date(this.formData.date);o.setDate(o.getDate()+e);const t=o.getFullYear(),s=(o.getMonth()+1).toString().padStart(2,"0"),r=o.getDate().toString().padStart(2,"0");this.formData.date=`${t}-${s}-${r}`},validateGlucose(e){const o=parseFloat(this.formData[e]);this.glucoseErrors[e]="",this.formData[e]&&(isNaN(o)?this.glucoseErrors[e]="请输入有效数值":("fastingGlucose"===e&&(o<3?this.glucoseErrors[e]="血糖值过低，请确认是否正确":o>7&&(this.glucoseErrors[e]="血糖值偏高，请注意控制")),"postprandialGlucose"===e&&(o<3?this.glucoseErrors[e]="血糖值过低，请确认是否正确":o>11.1?this.glucoseErrors[e]="血糖值过高，请及时就医":o>7.8&&(this.glucoseErrors[e]="血糖值偏高，请注意控制"))))},submitForm(){this.isFormValid&&this.$refs.form.validate().then((s=>{if(s){this.validateGlucose("fastingGlucose"),this.validateGlucose("postprandialGlucose"),(this.glucoseErrors.fastingGlucose||this.glucoseErrors.postprandialGlucose)&&e.index.showToast({title:"血糖值异常，但仍可提交",icon:"none",duration:2e3}),e.index.showLoading({title:"提交中..."});const s=t.getWechatLoginState();if(!s.isLoggedIn)return e.index.hideLoading(),e.index.showToast({title:"您尚未登录",icon:"none"}),void setTimeout((()=>{o.checkLoginAndRedirect()}),1500);e.nr.callFunction({name:"glucose-service",data:{action:"add",params:{userId:s.userInfo._id||s.openid,date:this.formData.date,fastingGlucose:this.formData.fastingGlucose,postprandialGlucose:this.formData.postprandialGlucose}}}).then((o=>{e.index.hideLoading(),o.result&&0===o.result.code?(e.index.showToast({title:o.result.message||"提交成功",icon:"success"}),this.formData={date:this.getCurrentDate(),fastingGlucose:"",postprandialGlucose:""},this.glucoseErrors={fastingGlucose:"",postprandialGlucose:""}):e.index.showToast({title:o.result&&o.result.message||"提交失败",icon:"none"})})).catch((o=>{e.index.hideLoading(),e.index.showToast({title:"网络错误，请稍后重试",icon:"none"}),console.error("提交血糖数据失败",o)}))}else e.index.showToast({title:"请填写完整信息",icon:"none"})})).catch((e=>{console.log("表单错误：",e)}))}}};if(!Array){(e.resolveComponent("uni-icons")+e.resolveComponent("uni-datetime-picker")+e.resolveComponent("uni-forms-item")+e.resolveComponent("uni-easyinput")+e.resolveComponent("uni-forms"))()}Math||((()=>"../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+(()=>"../../uni_modules/uni-datetime-picker/components/uni-datetime-picker/uni-datetime-picker.js")+(()=>"../../uni_modules/uni-forms/components/uni-forms-item/uni-forms-item.js")+(()=>"../../uni_modules/uni-easyinput/components/uni-easyinput/uni-easyinput.js")+(()=>"../../uni_modules/uni-forms/components/uni-forms/uni-forms.js"))();const r=e._export_sfc(s,[["render",function(o,t,s,r,i,a){return e.e({a:e.o((e=>a.changeDate(-1))),b:e.p({type:"left",size:"20",color:"#666"}),c:e.o((e=>i.formData.date=e)),d:e.p({type:"date",modelValue:i.formData.date}),e:e.o((e=>a.changeDate(1))),f:e.p({type:"right",size:"20",color:"#666"}),g:e.p({label:"日期",required:!0}),h:i.isNarrowScreen?1:"",i:e.o((e=>a.validateGlucose("fastingGlucose"))),j:e.o((e=>i.formData.fastingGlucose=e)),k:e.p({type:"digit",placeholder:"请输入","input-border":!1,modelValue:i.formData.fastingGlucose}),l:i.glucoseErrors.fastingGlucose},i.glucoseErrors.fastingGlucose?{m:e.t(i.glucoseErrors.fastingGlucose)}:{},{n:e.p({label:"空腹血糖值",required:!0}),o:i.isNarrowScreen?1:"",p:e.o((e=>a.validateGlucose("postprandialGlucose"))),q:e.o((e=>i.formData.postprandialGlucose=e)),r:e.p({type:"digit",placeholder:"请输入","input-border":!1,modelValue:i.formData.postprandialGlucose}),s:i.glucoseErrors.postprandialGlucose},i.glucoseErrors.postprandialGlucose?{t:e.t(i.glucoseErrors.postprandialGlucose)}:{},{v:e.p({label:"餐后两小时血糖值",required:!0}),w:i.isNarrowScreen?1:"",x:a.isFormValid?"primary":"default",y:e.o(((...e)=>a.submitForm&&a.submitForm(...e))),z:!a.isFormValid,A:a.isFormValid?"":1,B:a.isFormValid?1:"",C:e.sr("form","26578643-0"),D:e.p({modelValue:i.formData,rules:i.rules,validateTrigger:"bind"})})}]]);wx.createPage(r);
