"use strict";const e=require("../../common/vendor.js"),t=require("../../common/api/wechat.js"),o=require("../../common/api/login.js"),a=require("../../common/assets.js"),i={data:()=>({isLoggedIn:!1,userInfo:null,openid:"",formData:{name:"",contactMethod:"",contactPerson:"",notes:"",gender:"男",phone:"",height:"",weight:"",bmi:"",bloodPressure:"",basicDisease:""},genderOptions:[{text:"男",value:"男"},{text:"女",value:"女"}]}),onLoad(){o.checkLoginAndRedirect()&&this.initPageData()},onShow(){o.checkLoginAndRedirect()&&this.initPageData()},methods:{initPageData(){const e=t.getWechatLoginState();this.isLoggedIn=e.isLoggedIn,this.openid=e.openid,this.userInfo=e.userInfo,this.getUserInfo()},handleWechatLogin(){try{t.isWechatMP(),e.index.showLoading({title:"登录中..."}),t.wechatLogin().then((t=>{e.index.hideLoading(),this.isLoggedIn=!0,this.openid=t.openid,this.userInfo=t.userInfo,this.getUserInfo(),e.index.showToast({title:"登录成功",icon:"success"})})).catch((t=>{e.index.hideLoading(),console.error("登录失败",t),e.index.showToast({title:"登录失败，请重试",icon:"none"})}))}catch(o){e.index.hideLoading(),console.error("登录过程出错:",o),e.index.showToast({title:"登录出错，请重试",icon:"none"})}},getUserInfo(){this.openid&&(e.index.showLoading({title:"加载中..."}),e.nr.callFunction({name:"user-service",data:{action:"getUserByOpenid",params:{openid:this.openid}},success:t=>{if(e.index.hideLoading(),0===t.result.code&&t.result.data){const e=t.result.data;this.formData={name:e.name||"",contactMethod:e.contactMethod||"",contactPerson:e.contactPerson||"",notes:e.notes||"",gender:e.gender||"男",phone:e.phone||"",height:e.height?String(e.height):"",weight:e.weight?String(e.weight):"",bmi:e.bmi||"",bloodPressure:e.bloodPressure||"",basicDisease:e.basicDisease||""},this.formData.height&&this.formData.weight&&!this.formData.bmi&&this.calculateBMI()}else this.userInfo&&this.userInfo.nickName&&(this.formData.name=this.userInfo.nickName),this.userInfo&&void 0!==this.userInfo.gender&&(this.formData.gender=1===this.userInfo.gender?"男":"女")},fail:t=>{e.index.hideLoading(),console.error("获取用户信息失败",t)}}))},calculateBMI(){const e=parseFloat(this.formData.height),t=parseFloat(this.formData.weight);if(e&&t&&e>0){const o=e/100,a=t/(o*o);this.formData.bmi=a.toFixed(2)}else this.formData.bmi=""},submitForm(){this.$refs.form.validate().then((t=>{t&&(e.index.showLoading({title:"保存中..."}),this.formData.height&&this.formData.weight&&this.calculateBMI(),e.nr.callFunction({name:"user-service",data:{action:"updateUserInfo",params:{openid:this.openid,name:this.formData.name,contactMethod:this.formData.contactMethod,contactPerson:this.formData.contactPerson,notes:this.formData.notes,gender:this.formData.gender,phone:this.formData.phone,height:this.formData.height?parseFloat(this.formData.height):null,weight:this.formData.weight?parseFloat(this.formData.weight):null,bmi:this.formData.bmi,bloodPressure:this.formData.bloodPressure,basicDisease:this.formData.basicDisease}},success:t=>{e.index.hideLoading(),0===t.result.code?e.index.showToast({title:"保存成功",icon:"success"}):e.index.showToast({title:t.result.message||"保存失败",icon:"none"})},fail:t=>{e.index.hideLoading(),console.error("保存用户信息失败",t),e.index.showToast({title:"保存失败，请重试",icon:"none"})}}))}))}}};if(!Array){(e.resolveComponent("uni-easyinput")+e.resolveComponent("uni-forms-item")+e.resolveComponent("uni-data-checkbox")+e.resolveComponent("uni-forms"))()}Math||((()=>"../../uni_modules/uni-easyinput/components/uni-easyinput/uni-easyinput.js")+(()=>"../../uni_modules/uni-forms/components/uni-forms-item/uni-forms-item.js")+(()=>"../../uni_modules/uni-data-checkbox/components/uni-data-checkbox/uni-data-checkbox.js")+(()=>"../../uni_modules/uni-forms/components/uni-forms/uni-forms.js"))();const n=e._export_sfc(i,[["render",function(t,o,i,n,s,r){return e.e({a:!s.isLoggedIn},s.isLoggedIn?{d:s.userInfo.avatarUrl||"/static/icons/user-avatar-placeholder.png",e:e.t(s.userInfo.nickName||"微信用户"),f:e.o((e=>s.formData.name=e)),g:e.p({type:"text",placeholder:"请输入姓名",modelValue:s.formData.name}),h:e.p({label:"姓名",required:!0}),i:e.o((e=>s.formData.contactMethod=e)),j:e.p({type:"text",placeholder:"请输入联系方式",modelValue:s.formData.contactMethod}),k:e.p({label:"联系方式"}),l:e.o((e=>s.formData.contactPerson=e)),m:e.p({type:"text",placeholder:"请输入联系人姓名",modelValue:s.formData.contactPerson}),n:e.p({label:"联系人"}),o:e.o((e=>s.formData.notes=e)),p:e.p({type:"textarea",placeholder:"请输入备注信息",modelValue:s.formData.notes}),q:e.p({label:"备注"}),r:e.o((e=>s.formData.gender=e)),s:e.p({localdata:s.genderOptions,modelValue:s.formData.gender}),t:e.p({label:"性别",required:!0}),v:e.o((e=>s.formData.phone=e)),w:e.p({type:"number",placeholder:"请输入电话号码",modelValue:s.formData.phone}),x:e.p({label:"电话"}),y:e.o((e=>s.formData.height=e)),z:e.p({type:"number",placeholder:"请输入身高(cm)",modelValue:s.formData.height}),A:e.p({label:"身高(cm)"}),B:e.o(r.calculateBMI),C:e.o((e=>s.formData.weight=e)),D:e.p({type:"digit",placeholder:"请输入体重(kg)",modelValue:s.formData.weight}),E:e.p({label:"体重(kg)"}),F:e.o((e=>s.formData.bmi=e)),G:e.p({type:"text",disabled:!0,modelValue:s.formData.bmi}),H:e.p({label:"BMI"}),I:e.o((e=>s.formData.bloodPressure=e)),J:e.p({type:"text",placeholder:"例如: 120/80",modelValue:s.formData.bloodPressure}),K:e.p({label:"血压(mmHg)"}),L:e.o((e=>s.formData.basicDisease=e)),M:e.p({type:"textarea",placeholder:"请输入基础疾病信息",modelValue:s.formData.basicDisease}),N:e.p({label:"基础疾病"}),O:e.o(((...e)=>r.submitForm&&r.submitForm(...e))),P:e.sr("form","5f7f6c12-0"),Q:e.p({modelValue:s.formData})}:{b:a._imports_0,c:e.o(((...e)=>r.handleWechatLogin&&r.handleWechatLogin(...e)))})}]]);wx.createPage(n);
