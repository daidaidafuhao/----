"use strict";const e=require("../../common/vendor.js"),t=require("../../common/api/wechat.js"),o=require("../../common/api/login.js"),a=require("../../common/assets.js"),i={data:()=>({isPageVisible:!1,isLoggedIn:!1,userInfo:null,openid:"",formData:{name:"",contactMethod:"",contactPerson:"",notes:"",gender:"男",phone:"",height:"",weight:"",bmi:"",bloodPressure:"",basicDisease:""},genderOptions:[{text:"男",value:"男"},{text:"女",value:"女"}]}),onLoad(){this.getPageConfig(),o.checkLoginAndRedirect()&&this.initPageData()},onShow(){this.getPageConfig(),o.checkLoginAndRedirect()&&this.initPageData()},methods:{async getPageConfig(){try{const t=await e.nr.callFunction({name:"page-config",data:{action:"getConfig",params:{pageId:"user-info"}}});0===t.result.code?(console.log("页面配置",t.result.data.isVisible),this.isPageVisible=t.result.data.isVisible):(console.error("获取页面配置失败:",t.result.message),this.isPageVisible=!1)}catch(t){console.error("获取页面配置出错:",t),this.isPageVisible=!1}},initPageData(){const e=t.getWechatLoginState();this.isLoggedIn=e.isLoggedIn,this.openid=e.openid,this.userInfo=e.userInfo,this.getUserInfo()},handleWechatLogin(){try{t.isWechatMP(),e.index.showLoading({title:"登录中..."}),t.wechatLogin().then((t=>{e.index.hideLoading(),this.isLoggedIn=!0,this.openid=t.openid,this.userInfo=t.userInfo,this.getUserInfo(),e.index.showToast({title:"登录成功",icon:"success"})})).catch((t=>{e.index.hideLoading(),console.error("登录失败",t),e.index.showToast({title:"登录失败，请重试",icon:"none"})}))}catch(o){e.index.hideLoading(),console.error("登录过程出错:",o),e.index.showToast({title:"登录出错，请重试",icon:"none"})}},getUserInfo(){this.openid&&(e.index.showLoading({title:"加载中..."}),e.nr.callFunction({name:"user-service",data:{action:"getUserByOpenid",params:{openid:this.openid}},success:t=>{if(e.index.hideLoading(),0===t.result.code&&t.result.data){const e=t.result.data;this.formData={name:e.name||"",contactMethod:e.contactMethod||"",contactPerson:e.contactPerson||"",notes:e.notes||"",gender:e.gender||"男",phone:e.phone||"",height:e.height?String(e.height):"",weight:e.weight?String(e.weight):"",bmi:e.bmi||"",bloodPressure:e.bloodPressure||"",basicDisease:e.basicDisease||""},this.formData.height&&this.formData.weight&&!this.formData.bmi&&this.calculateBMI()}else this.userInfo&&this.userInfo.nickName&&(this.formData.name=this.userInfo.nickName),this.userInfo&&void 0!==this.userInfo.gender&&(this.formData.gender=1===this.userInfo.gender?"男":"女")},fail:t=>{e.index.hideLoading(),console.error("获取用户信息失败",t)}}))},calculateBMI(){const e=parseFloat(this.formData.height),t=parseFloat(this.formData.weight);if(e&&t&&e>0){const o=e/100,a=t/(o*o);this.formData.bmi=a.toFixed(2)}else this.formData.bmi=""},submitForm(){this.$refs.form.validate().then((t=>{t&&(e.index.showLoading({title:"保存中..."}),this.formData.height&&this.formData.weight&&this.calculateBMI(),e.nr.callFunction({name:"user-service",data:{action:"updateUserInfo",params:{openid:this.openid,name:this.formData.name,contactMethod:this.formData.contactMethod,contactPerson:this.formData.contactPerson,notes:this.formData.notes,gender:this.formData.gender,phone:this.formData.phone,height:this.formData.height?parseFloat(this.formData.height):null,weight:this.formData.weight?parseFloat(this.formData.weight):null,bmi:this.formData.bmi,bloodPressure:this.formData.bloodPressure,basicDisease:this.formData.basicDisease}},success:t=>{e.index.hideLoading(),0===t.result.code?e.index.showToast({title:"保存成功",icon:"success"}):e.index.showToast({title:t.result.message||"保存失败",icon:"none"})},fail:t=>{e.index.hideLoading(),console.error("保存用户信息失败",t),e.index.showToast({title:"保存失败，请重试",icon:"none"})}}))}))}}};if(!Array){(e.resolveComponent("uni-easyinput")+e.resolveComponent("uni-forms-item")+e.resolveComponent("uni-data-checkbox")+e.resolveComponent("uni-forms"))()}Math||((()=>"../../uni_modules/uni-easyinput/components/uni-easyinput/uni-easyinput.js")+(()=>"../../uni_modules/uni-forms/components/uni-forms-item/uni-forms-item.js")+(()=>"../../uni_modules/uni-data-checkbox/components/uni-data-checkbox/uni-data-checkbox.js")+(()=>"../../uni_modules/uni-forms/components/uni-forms/uni-forms.js"))();const s=e._export_sfc(i,[["render",function(t,o,i,s,n,r){return e.e({a:!n.isPageVisible},n.isPageVisible?e.e({b:!n.isLoggedIn},n.isLoggedIn?{e:n.userInfo.avatarUrl||"/static/icons/user-avatar-placeholder.png",f:e.t(n.userInfo.nickName||"微信用户"),g:e.o((e=>n.formData.name=e)),h:e.p({type:"text",placeholder:"请输入姓名",modelValue:n.formData.name}),i:e.p({label:"姓名",required:!0}),j:e.o((e=>n.formData.contactMethod=e)),k:e.p({type:"text",placeholder:"请输入联系方式",modelValue:n.formData.contactMethod}),l:e.p({label:"联系方式"}),m:e.o((e=>n.formData.contactPerson=e)),n:e.p({type:"text",placeholder:"请输入联系人姓名",modelValue:n.formData.contactPerson}),o:e.p({label:"联系人"}),p:e.o((e=>n.formData.notes=e)),q:e.p({type:"textarea",placeholder:"请输入备注信息",modelValue:n.formData.notes}),r:e.p({label:"备注"}),s:e.o((e=>n.formData.gender=e)),t:e.p({localdata:n.genderOptions,modelValue:n.formData.gender}),v:e.p({label:"性别",required:!0}),w:e.o((e=>n.formData.phone=e)),x:e.p({type:"number",placeholder:"请输入电话号码",modelValue:n.formData.phone}),y:e.p({label:"电话"}),z:e.o((e=>n.formData.height=e)),A:e.p({type:"number",placeholder:"请输入身高(cm)",modelValue:n.formData.height}),B:e.p({label:"身高(cm)"}),C:e.o(r.calculateBMI),D:e.o((e=>n.formData.weight=e)),E:e.p({type:"digit",placeholder:"请输入体重(kg)",modelValue:n.formData.weight}),F:e.p({label:"体重(kg)"}),G:e.o((e=>n.formData.bmi=e)),H:e.p({type:"text",disabled:!0,modelValue:n.formData.bmi}),I:e.p({label:"BMI"}),J:e.o((e=>n.formData.bloodPressure=e)),K:e.p({type:"text",placeholder:"例如: 120/80",modelValue:n.formData.bloodPressure}),L:e.p({label:"血压(mmHg)"}),M:e.o((e=>n.formData.basicDisease=e)),N:e.p({type:"textarea",placeholder:"请输入基础疾病信息",modelValue:n.formData.basicDisease}),O:e.p({label:"基础疾病"}),P:e.o(((...e)=>r.submitForm&&r.submitForm(...e))),Q:e.sr("form","7eb2cfe4-0"),R:e.p({modelValue:n.formData})}:{c:a._imports_0,d:e.o(((...e)=>r.handleWechatLogin&&r.handleWechatLogin(...e)))}):{})}]]);wx.createPage(s);
