"use strict";const e=require("../../common/vendor.js"),t=require("../../common/api/admin.js"),o=require("../../common/assets.js"),n={data:()=>({dateRanges:["最近一周","最近一个月","最近三个月","自定义"],dateRangeIndex:1,customStartDate:"",customEndDate:"",formats:["Excel (.xlsx)","CSV (.csv)"],formatIndex:0,userCount:0,recordCount:0,lastWeekCount:0,activeUserCount:0,loading:!1,exportLoading:!1,missingExportLoading:!1,showQRModal:!1,missingStartDate:"",missingEndDate:""}),created(){this.customEndDate=this.getCurrentDate(),this.customStartDate=this.getLastMonthDate(),this.missingEndDate=this.getCurrentDate(),this.missingStartDate=this.getLastWeekDate()},onLoad(){this.loadStatistics()},methods:{loadStatistics(){const o=e.index.getStorageSync("openid");if(!o)return e.index.showToast({title:"登录状态已失效",icon:"none"}),void setTimeout((()=>{e.index.redirectTo({url:"/pages/login/index"})}),1500);this.loading=!0,e.index.showLoading({title:"加载中..."}),t.getStatistics(o).then((t=>{this.loading=!1,e.index.hideLoading(),0===t.code?(this.userCount=t.data.userCount,this.recordCount=t.data.recordCount,this.lastWeekCount=t.data.lastWeekCount,this.activeUserCount=t.data.activeUserCount):403===t.code?(e.index.showToast({title:"无权访问管理页面",icon:"none"}),setTimeout((()=>{e.index.switchTab({url:"/pages/data-entry/index"})}),1500)):e.index.showToast({title:"获取统计数据失败",icon:"none"})})).catch((t=>{this.loading=!1,e.index.hideLoading(),e.index.showToast({title:"获取统计数据失败",icon:"none"}),console.error("获取统计数据出错",t)}))},getCurrentDate(){const e=new Date;return`${e.getFullYear()}-${(e.getMonth()+1).toString().padStart(2,"0")}-${e.getDate().toString().padStart(2,"0")}`},getLastMonthDate(){const e=new Date;e.setMonth(e.getMonth()-1);return`${e.getFullYear()}-${(e.getMonth()+1).toString().padStart(2,"0")}-${e.getDate().toString().padStart(2,"0")}`},handleDateRangeChange(e){this.dateRangeIndex=e.detail.value,console.log(this.dateRangeIndex),console.log("3"===this.dateRangeIndex)},handleFormatChange(e){this.formatIndex=e.detail.value,console.log(this.formatIndex)},onStartDateChange(e){this.customStartDate=e.detail.value},onEndDateChange(e){this.customEndDate=e.detail.value},onMissingStartDateChange(e){this.missingStartDate=e.detail.value},onMissingEndDateChange(e){this.missingEndDate=e.detail.value},getLastWeekDate(){const e=new Date;e.setDate(e.getDate()-7);return`${e.getFullYear()}-${(e.getMonth()+1).toString().padStart(2,"0")}-${e.getDate().toString().padStart(2,"0")}`},exportData(){const t=e.index.getStorageSync("openid");if(!t)return void e.index.showToast({title:"登录状态已失效",icon:"none"});let o=null;switch(this.dateRangeIndex){case"0":{const e=new Date,t=new Date;t.setDate(e.getDate()-7),o={startDate:t.toISOString().split("T")[0],endDate:e.toISOString().split("T")[0]}}break;case"1":{const e=new Date,t=new Date;t.setMonth(e.getMonth()-1),o={startDate:t.toISOString().split("T")[0],endDate:e.toISOString().split("T")[0]}}break;case"2":{const e=new Date,t=new Date;t.setMonth(e.getMonth()-3),o={startDate:t.toISOString().split("T")[0],endDate:e.toISOString().split("T")[0]}}break;case"3":o={startDate:this.customStartDate,endDate:this.customEndDate},console.log("自定义日期范围:",o)}this.exportLoading=!0,e.index.showLoading({title:"导出中..."});const n="excel"===this.formats[this.formatIndex].toLowerCase().split(" ")[0]?"xlsx":"csv";this.doExport(t,o,n)},doExport(o,n,a){t.exportAllData(o,n,a).then((t=>{if(this.exportLoading=!1,e.index.hideLoading(),0===t.code){const n=t.data;try{if(!n.fileContent)throw new Error("文件内容为空");this.saveFileFromBase64(n.fileName,n.fileContent,n.fileType),e.index.showToast({title:"数据导出成功",icon:"success"})}catch(o){console.error("保存导出文件失败",o),e.index.showModal({title:"导出失败",content:`处理数据时出错: ${o.message||"未知错误"}`,showCancel:!1})}}else 403===t.code?e.index.showToast({title:"无权执行导出操作",icon:"none"}):e.index.showModal({title:"导出失败",content:t.message||"未知错误",showCancel:!1})})).catch((t=>{this.exportLoading=!1,e.index.hideLoading(),e.index.showModal({title:"导出数据失败",content:t.message||"未知错误",showCancel:!1}),console.error("导出数据出错",t)}))},saveFileFromBase64(t,o,n){let a=!1;try{if(void 0!==e.wx$1){const t=e.wx$1.getAppBaseInfo?e.wx$1.getAppBaseInfo():null;if(a=!!t&&"mp-weixin"===t.platform,!a&&void 0!==e.index&&e.index.getSystemInfoSync){a="mp-weixin"===e.index.getSystemInfoSync().uniPlatform}}}catch(s){console.warn("环境检测失败，默认使用移动端处理",s),a=!0}a||"undefined"==typeof window?this.saveFileOnMobileFromBase64(t,o,n):this.saveFileOnWebFromBase64(t,o,n)},saveFileOnMobileFromBase64(t,o,n){try{console.log("开始处理文件保存:",t);if(/\.(pdf|xlsx|xls|csv)$/i.test(t))return console.log("尝试直接预览文件内容"),void this.previewFileFromBase64(t,o,n);this.saveFileToLocalStorage(t,o,n)}catch(a){console.error("处理文件保存时出错",a),e.index.showModal({title:"保存文件出错",content:a.message||"未知错误",showCancel:!1})}},previewFileFromBase64(t,o,n){try{const i=e.index.getFileSystemManager(),r=`${e.index.env.USER_DATA_PATH}/temp_preview_${t}`;let c=this.convertBase64ToArrayBuffer(o);try{const s=r.substring(0,r.lastIndexOf("/"));try{i.accessSync(s)}catch(a){console.log("创建预览临时目录"),i.mkdirSync(s,!0)}try{i.accessSync(r),i.unlinkSync(r),console.log("删除已存在的预览临时文件")}catch(a){}i.writeFileSync(r,c,"binary"),console.log("预览临时文件写入成功:",r),e.index.openDocument({filePath:r,showMenu:!0,success:()=>{console.log("成功打开预览文档"),e.index.showToast({title:"文件已打开",icon:"success"}),setTimeout((()=>{e.index.showModal({title:"文件已打开",content:'您可以使用右上角的"更多"选项保存文件',confirmText:"我知道了",showCancel:!1})}),1e3)},fail:a=>{console.error("预览文档失败",a),e.index.showModal({title:"预览失败",content:"无法直接预览，将尝试保存文件",showCancel:!1,success:()=>{this.saveFileToLocalStorage(t,o,n)}})}})}catch(s){throw console.error("写入预览临时文件失败",s),new Error(`写入预览临时文件失败: ${s.message||"未知错误"}`)}}catch(i){console.error("预览文件失败",i),this.saveFileToLocalStorage(t,o,n)}},saveFileToLocalStorage(t,o,n){try{console.log("尝试保存文件到本地存储");const n=e.index.getFileSystemManager(),i=`${e.index.env.USER_DATA_PATH}/temp_${t}`;let r=this.convertBase64ToArrayBuffer(o);try{const e=i.substring(0,i.lastIndexOf("/"));try{n.accessSync(e)}catch(a){n.mkdirSync(e,!0),console.log("创建保存目录")}}catch(s){console.error("创建目录失败",s)}try{n.accessSync(i),n.unlinkSync(i),console.log("删除同名文件")}catch(a){}n.writeFileSync(i,r,"binary"),console.log("文件写入成功:",i),e.index.saveFile({tempFilePath:i,success:t=>{console.log("文件保存成功:",t.savedFilePath),e.index.openDocument({filePath:t.savedFilePath,showMenu:!0,success:()=>{console.log("打开保存的文件成功"),e.index.showToast({title:"文件已保存并打开",icon:"success"})},fail:t=>{console.error("打开文件失败",t),e.index.showModal({title:"保存成功",content:"文件已保存，但无法自动打开",showCancel:!1})}})},fail:t=>{console.error("保存文件失败",t),void 0!==e.wx$1?e.index.showModal({title:"保存失败",content:'请使用右上角"..."菜单中的"复制链接"或"分享给朋友"功能来保存文件',confirmText:"我知道了",showCancel:!1}):e.index.showModal({title:"保存失败",content:`保存文件失败: ${t.errMsg||"未知错误"}`,showCancel:!1})}})}catch(i){console.error("保存到本地存储失败",i),e.index.showModal({title:"保存失败",content:i.message||"未知错误",showCancel:!1})}},convertBase64ToArrayBuffer(t){try{let a,s=t;if(s.includes(",")&&(s=s.split(",")[1]),s=s.replace(/[\r\n]/g,""),void 0!==e.wx$1&&e.wx$1.base64ToArrayBuffer)try{a=e.wx$1.base64ToArrayBuffer(s),console.log("使用wx.base64ToArrayBuffer成功")}catch(o){console.warn("wx.base64ToArrayBuffer失败",o)}if(!a&&e.index.base64ToArrayBuffer)try{a=e.index.base64ToArrayBuffer(s),console.log("使用uni.base64ToArrayBuffer成功")}catch(n){console.warn("uni.base64ToArrayBuffer失败",n)}if(!a){console.log("使用通用JavaScript方法转换Base64");const e=this.atob(s),t=new Uint8Array(e.length);for(let o=0;o<e.length;o++)t[o]=e.charCodeAt(o);a=t.buffer}if(!a)throw new Error("无法转换Base64到ArrayBuffer");return a}catch(a){throw console.error("Base64转换失败",a),new Error(`Base64转换失败: ${a.message||"未知错误"}`)}},atob(e){if("function"==typeof atob)return atob(e);let t="";for(let o,n,a=0,s=0;n=e.charAt(s++);~n&&(o=a%4?64*o+n:n,a++%4)?t+=String.fromCharCode(255&o>>(-2*a&6)):0)n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(n);return t},saveFileOnWebFromBase64(t,o,n){try{if("undefined"==typeof window||"undefined"==typeof document||"undefined"==typeof Blob||"undefined"==typeof URL)throw new Error("当前环境不支持网页下载方式");const a=atob(o),s=new Array(a.length);for(let e=0;e<a.length;e++)s[e]=a.charCodeAt(e);const i=new Uint8Array(s),r=new Blob([i],{type:n}),c=URL.createObjectURL(r),d=document.createElement("a");d.href=c,d.download=t,document.body.appendChild(d),d.click(),setTimeout((()=>{document.body.removeChild(d),URL.revokeObjectURL(c)}),0),e.index.showToast({title:"文件下载成功",icon:"success"})}catch(a){console.error("网页下载方式失败",a),this.saveFileOnMobileFromBase64(t,o,n)}},exportMissingData(){if(!e.index.getStorageSync("openid"))return void e.index.showToast({title:"登录状态已失效",icon:"none"});this.missingExportLoading=!0,e.index.showLoading({title:"导出中..."});const t="excel"===this.formats[this.formatIndex].toLowerCase().split(" ")[0]?"xlsx":"csv";e.nr.callFunction({name:"admin-service",data:{action:"exportMissingRecords",params:{dateRange:{startDate:this.missingStartDate,endDate:this.missingEndDate},format:t}}}).then((t=>{if(this.missingExportLoading=!1,e.index.hideLoading(),0===t.result.code){const n=t.result.data;try{if(!n.fileContent)throw new Error("文件内容为空");this.saveFileFromBase64(n.fileName,n.fileContent,n.fileType),e.index.showToast({title:"导出成功",icon:"success"})}catch(o){console.error("保存导出文件失败",o),e.index.showModal({title:"导出失败",content:`处理数据时出错: ${o.message||"未知错误"}`,showCancel:!1})}}else 403===t.result.code?e.index.showToast({title:"无权执行导出操作",icon:"none"}):e.index.showModal({title:"导出失败",content:t.result.message||"未知错误",showCancel:!1})})).catch((t=>{this.missingExportLoading=!1,e.index.hideLoading(),e.index.showModal({title:"导出数据失败",content:t.message||"未知错误",showCancel:!1}),console.error("导出数据出错",t)}))}}};const a=e._export_sfc(n,[["render",function(t,n,a,s,i,r){return e.e({a:e.t(i.dateRanges[i.dateRangeIndex]),b:e.o(((...e)=>r.handleDateRangeChange&&r.handleDateRangeChange(...e))),c:i.dateRangeIndex,d:i.dateRanges,e:"3"===i.dateRangeIndex},"3"===i.dateRangeIndex?{f:e.t(i.customStartDate),g:i.customStartDate,h:e.o(((...e)=>r.onStartDateChange&&r.onStartDateChange(...e)))}:{},{i:"3"===i.dateRangeIndex},"3"===i.dateRangeIndex?{j:e.t(i.customEndDate),k:i.customEndDate,l:e.o(((...e)=>r.onEndDateChange&&r.onEndDateChange(...e)))}:{},{m:e.t(i.formats[i.formatIndex]),n:e.o(((...e)=>r.handleFormatChange&&r.handleFormatChange(...e))),o:i.formatIndex,p:i.formats,q:e.o(((...e)=>r.exportData&&r.exportData(...e))),r:i.exportLoading,s:e.t(i.missingStartDate),t:i.missingStartDate,v:e.o(((...e)=>r.onMissingStartDateChange&&r.onMissingStartDateChange(...e))),w:e.t(i.missingEndDate),x:i.missingEndDate,y:e.o(((...e)=>r.onMissingEndDateChange&&r.onMissingEndDateChange(...e))),z:e.o(((...e)=>r.exportMissingData&&r.exportMissingData(...e))),A:i.missingExportLoading,B:e.t(i.userCount),C:e.t(i.recordCount),D:e.t(i.lastWeekCount),E:e.t(i.activeUserCount),F:i.showQRModal},i.showQRModal?{G:o._imports_0$1,H:e.o(((...e)=>t.hideQRCode&&t.hideQRCode(...e))),I:e.o((()=>{})),J:e.o(((...e)=>t.hideQRCode&&t.hideQRCode(...e)))}:{})}]]);wx.createPage(a);
