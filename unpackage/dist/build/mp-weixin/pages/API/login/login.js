"use strict";const e=require("../../../common/vendor.js"),n={data:()=>({title:"login",providerList:[],phoneNumber:"",univerifyBtnLoading:!1}),computed:{...e.mapState(["hasLogin","isUniverifyLogin","univerifyErrorMsg"])},onLoad(){e.index.getProvider({service:"oauth",success:e=>{this.providerList=e.provider.map((e=>{let n="";switch(e){case"weixin":n="微信登录";break;case"qq":n="QQ登录";break;case"sinaweibo":n="新浪微博登录";break;case"xiaomi":n="小米登录";break;case"alipay":n="支付宝登录";break;case"baidu":n="百度登录";break;case"jd":n="京东登录";break;case"toutiao":n="头条登录";break;case"apple":n="苹果登录";break;case"univerify":n="一键登录"}return{name:n,id:e}}))},fail:e=>{console.log("获取登录通道失败",e)}}),this.hasLogin&&this.isUniverifyLogin&&this.getPhoneNumber(e.index.getStorageSync("univerifyInfo")).then((e=>{this.phoneNumber=e}))},methods:{...e.mapMutations(["login","setUniverifyLogin"]),...e.mapActions(["getPhoneNumber"]),Toast(n,i=1e3){e.index.showToast(Object.assign({},n,{duration:i}))},tologin(n){"univerify"===n.id&&(this.univerifyBtnLoading=!0),e.index.login({provider:n.id,success:async i=>{console.log("login success:",i),this.Toast({title:"登录成功"}),this.login(n.id),console.warn("如需获取openid请参考uni-id: https://uniapp.dcloud.net.cn/uniCloud/uni-id"),e.index.request({url:"https://97fca9f2-41f6-449f-a35e-3f135d4c3875.bspapp.com/http/user-center",method:"POST",data:{action:"loginByWeixin",params:{code:i.code,platform:"mp-weixin"}},success:n=>{if(console.log(n),0!==n.data.code)return console.log("获取openid失败：",n.data.errMsg),void e.index.showModal({title:"登录失败",content:"获取用户信息失败，请稍后再试",showCancel:!1});e.index.setStorageSync("openid",n.data.openid),e.index.getUserProfile({desc:"用于完善会员资料",success:i=>{e.index.setStorageSync("userInfo",i.userInfo),this.saveUserInfo(n.data.openid,i.userInfo),setTimeout((()=>{e.index.navigateBack()}),1500)},fail:e=>{console.log("获取用户信息失败",e)}})},fail:n=>{console.log("获取openid失败：",n),e.index.showModal({title:"登录失败",content:"网络请求失败，请检查网络连接",showCancel:!1})}})},fail:n=>{if(console.log("login fail:",n),"30002"==n.code)return e.index.closeAuthView(),void this.Toast({title:"其他登录方式"});1e3!=n.code?"30005"!=n.code?"30003"!=n.code&&e.index.showModal({showCancel:!1,title:"登录失败",content:JSON.stringify(n)}):e.index.showModal({showCancel:!1,title:"预登录失败",content:this.univerifyErrorMsg||n.errMsg}):e.index.showModal({title:"登录失败",content:`${n.errMsg}\n，错误码：${n.code}`,confirmText:"开通指南",cancelText:"确定",success:e=>{e.confirm&&setTimeout((()=>{plus.runtime.openWeb("https://ask.dcloud.net.cn/article/37965")}),500)}})},complete:()=>{this.univerifyBtnLoading=!1}})},loginByUniverify(n,i){this.setUniverifyLogin(!0),e.index.closeAuthView();const o={provider:n,...i.authResult};this.getPhoneNumber(o).then((n=>{this.phoneNumber=n,e.index.setStorageSync("univerifyInfo",o)})).catch((n=>{e.index.showModal({showCancel:!1,title:"手机号获取失败",content:`${n.errMsg}\n，错误码：${n.code}`}),console.error(i)}))},async loginByApple(n,i){let o,t;try{t=await e.index.getUserInfo({provider:n})}catch(s){o=s}if(o){let n=o.errMsg;~n.indexOf("uni.login")&&(n="请在登录页面完成登录操作"),e.index.showModal({title:"获取用户信息失败",content:"错误原因"+n,showCancel:!1})}console.warn("此处使用uni-id处理苹果登录，详情参考: https://uniapp.dcloud.net.cn/uniCloud/uni-id"),e.index.request({url:"https://97fca9f2-41f6-449f-a35e-3f135d4c3875.bspapp.com/http/user-center",method:"POST",data:{action:"loginByApple",params:t.userInfo},success:n=>{console.log("uniId login success",n),0!==n.data.code?e.index.showModal({showCancel:!1,content:`苹果登录失败: ${JSON.stringify(n.data.msg)}`}):(e.index.setStorageSync("openid",n.data.openid),e.index.setStorageSync("apple_nickname",n.data.userInfo.nickname))},fail:n=>{e.index.showModal({content:`苹果登录失败: ${JSON.stringify(n)}`,showCancel:!1})}})},saveUserInfo(n,i){e.index.showLoading({title:"保存用户信息"}),e.nr.callFunction({name:"user-service",data:{action:"saveWxUserInfo",params:{openid:n,nickName:i.nickName,avatarUrl:i.avatarUrl,gender:i.gender,country:i.country,province:i.province,city:i.city}},success:n=>{e.index.hideLoading(),0===n.result.code?e.index.showToast({title:"登录成功",duration:1500}):console.error("保存用户信息失败",n.result)},fail:n=>{e.index.hideLoading(),console.error("调用云函数失败",n)}})}}};if(!Array){e.resolveComponent("page-head")()}Math;const i=e._export_sfc(n,[["render",function(n,i,o,t,s,a){return e.e({a:e.p({title:s.title}),b:!0===n.hasLogin},!0===n.hasLogin?e.e({c:n.isUniverifyLogin},n.isUniverifyLogin?e.e({d:!s.phoneNumber.length},s.phoneNumber.length?{e:e.t(s.phoneNumber)}:{}):{}):{},{f:!1===n.hasLogin},(n.hasLogin,{}),{g:e.f(s.providerList,((n,i,o)=>({a:e.t(n.name),b:e.o((e=>a.tologin(n)),i),c:"univerify"===n.id&&s.univerifyBtnLoading,d:i})))})}]]);wx.createPage(i);
