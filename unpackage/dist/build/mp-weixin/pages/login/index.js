"use strict";const e=require("../../common/vendor.js"),n=require("../../common/assets.js"),o={data:()=>({loading:!1}),methods:{onGetUserInfo(n){if(!n.detail.userInfo)return void e.index.showToast({title:"需要授权才能使用",icon:"none"});if(this.loading)return;this.loading=!0,e.index.showLoading({title:"登录中..."});const o=n.detail.userInfo;e.index.login({provider:"weixin",success:n=>{const i=n.code;console.log("获取到登录code:",i),e.nr.callFunction({name:"wx-login",data:{code:i},success:n=>{var i;if(console.log("云函数调用成功:",n),n.result&&0===n.result.code){e.index.setStorageSync("openid",n.result.data.openid),e.index.setStorageSync("userInfo",o),e.index.hideLoading(),e.index.showToast({title:"登录成功",icon:"success"});const i=n.result.data.isAdmin;console.log("是否为管理员:",i),setTimeout((()=>{i?e.index.showActionSheet({itemList:["管理页面","填报页面"],success:n=>{0===n.tapIndex?e.index.reLaunch({url:"/pages/admin/index"}):e.index.switchTab({url:"/pages/data-entry/index"})}}):e.index.switchTab({url:"/pages/data-entry/index"})}),1500)}else e.index.hideLoading(),console.error("获取openid失败",n.result),e.index.showToast({title:"登录失败: "+((null==(i=n.result)?void 0:i.msg)||"未知错误"),icon:"none"}),this.loading=!1},fail:n=>{e.index.hideLoading(),console.error("云函数调用失败",n),e.index.showToast({title:"登录失败，请检查网络"+n.errMsg,icon:"none"}),this.loading=!1}})},fail:n=>{e.index.hideLoading(),console.error("微信登录失败",n),e.index.showToast({title:"登录失败，请重试",icon:"none"}),this.loading=!1}})}}};const i=e._export_sfc(o,[["render",function(o,i,s,t,d,r){return{a:n._imports_0,b:e.o(((...e)=>r.onGetUserInfo&&r.onGetUserInfo(...e)))}}]]);wx.createPage(i);
