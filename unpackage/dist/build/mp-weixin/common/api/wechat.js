"use strict";const r=require("../vendor.js");exports.getWechatLoginState=function(){try{const e=r.index.getStorageSync("openid");return{isLoggedIn:!!e,openid:e||"",userInfo:r.index.getStorageSync("userInfo")||null}}catch(e){return console.error("获取登录状态失败",e),{isLoggedIn:!1,openid:"",userInfo:null}}},exports.isWechatMP=function(){return!0},exports.wechatLogin=function(){return new Promise(((e,o)=>{try{r.index.login({provider:"weixin",success:n=>{console.log(n);try{(s=n.code,new Promise(((e,o)=>{try{console.log(s),r.index.request({url:"https://97fca9f2-41f6-449f-a35e-3f135d4c3875.bspapp.com/http/user-center",method:"POST",data:{action:"loginByWeixin",params:{code:s,platform:"mp-weixin"}},success:n=>{console.log(n);try{if(!n.data||0!==n.data.code){const r=n.data&&n.data.errMsg?n.data.errMsg:"获取openid失败";return void o(new Error(r))}r.index.setStorageSync("openid",n.data.openid),e({openid:n.data.openid,isAdmin:n.data.isAdmin})}catch(s){console.error("处理获取openid响应出错",s),o(s instanceof Error?s:new Error("处理获取openid响应出错"))}},fail:r=>{console.error("请求获取openid失败",r),o(r instanceof Error?r:new Error("请求获取openid失败"))}})}catch(n){console.error("发送获取openid请求出错",n),o(n instanceof Error?n:new Error("发送获取openid请求出错"))}}))).then((n=>{try{r.index.getUserProfile({desc:"用于完善会员资料",success:s=>{try{(t=n.openid,c=s.userInfo,new Promise(((e,o)=>{try{r.index.setStorageSync("userInfo",c),r.nr.callFunction({name:"user-service",data:{action:"saveWxUserInfo",params:{openid:t,userInfo:c}},success:r=>{try{if(!r.result||0!==r.result.code){const e=r.result&&r.result.message?r.result.message:"保存用户信息失败";return void o(new Error(e))}e({userId:r.result.data.userId,isNew:r.result.data.isNew})}catch(n){console.error("处理保存用户信息响应出错",n),o(n instanceof Error?n:new Error("处理保存用户信息响应出错"))}},fail:r=>{console.error("调用保存用户信息云函数失败",r),o(r instanceof Error?r:new Error("调用保存用户信息云函数失败"))}})}catch(n){console.error("保存用户信息过程出错",n),o(n instanceof Error?n:new Error("保存用户信息过程出错"))}}))).then((r=>{e({openid:n.openid,userInfo:s.userInfo,userId:r.userId,isAdmin:n.isAdmin||!1})})).catch((r=>{console.error("保存用户信息失败",r),o(r instanceof Error?r:new Error("保存用户信息失败"))}))}catch(i){console.error("处理用户信息出错",i),o(i instanceof Error?i:new Error("处理用户信息出错"))}var t,c},fail:r=>{console.error("获取用户信息失败",r),o(r instanceof Error?r:new Error("获取用户信息失败"))}})}catch(s){console.error("获取用户信息出错",s),o(s instanceof Error?s:new Error("获取用户信息出错"))}})).catch((r=>{console.error("获取openid失败",r),o(r instanceof Error?r:new Error("获取openid失败"))}))}catch(t){console.error("调用登录方法出错",t),o(t instanceof Error?t:new Error("调用登录方法出错"))}var s},fail:r=>{console.error("微信登录失败",r),o(r instanceof Error?r:new Error("微信登录失败"))}})}catch(n){console.error("微信登录过程出错",n),o(n instanceof Error?n:new Error("微信登录过程出错"))}}))};
