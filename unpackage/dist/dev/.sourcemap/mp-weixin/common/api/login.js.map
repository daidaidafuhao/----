{"version":3,"file":"login.js","sources":["common/api/login.js"],"sourcesContent":["import { getWechatLoginState, wechatLogin } from './wechat.js';\nimport store from '../../store/index.js';\n\n// 检查登录状态并处理未登录情况\nexport function checkLoginAndRedirect() {\n  const loginState = getWechatLoginState();\n  if (!loginState.isLoggedIn) {\n    // 未登录，跳转到登录页面\n    // 使用绝对路径（确保以/开头）\n    uni.redirectTo({\n      url: '/pages/login/index'\n    });\n    return false;\n  }\n  return true;\n}\n\n// 执行登录流程\nexport function doLogin() {\n  return new Promise((resolve, reject) => {\n    uni.showLoading({\n      title: '登录中...'\n    });\n    \n    wechatLogin()\n      .then(res => {\n        uni.hideLoading();\n        uni.showToast({\n          title: '登录成功',\n          icon: 'success'\n        });\n        \n        // 保存登录状态到Vuex\n        store.commit('login', 'weixin');\n        store.commit('setOpenid', res.openid);\n        \n        // 保存管理员状态到Vuex\n        if (res.isAdmin) {\n          store.commit('setAdmin', true);\n          \n          // 管理员用户跳转到管理页面\n          uni.reLaunch({\n            url: '/pages/admin/index'\n          });\n        } else {\n          store.commit('setAdmin', false);\n          \n          // 普通用户跳转到数据录入页面\n          uni.switchTab({\n            url: '/pages/data-entry/index'\n          });\n        }\n        \n        resolve(res);\n      })\n      .catch(err => {\n        uni.hideLoading();\n        uni.showToast({\n          title: '登录失败: ' + (err.message || '未知错误'),\n          icon: 'none'\n        });\n        reject(err);\n      });\n  });\n}\n\nexport default {\n  checkLoginAndRedirect,\n  doLogin\n}; "],"names":["getWechatLoginState","uni"],"mappings":";;;;AAIO,SAAS,wBAAwB;AACtC,QAAM,aAAaA,kBAAAA;AACnB,MAAI,CAAC,WAAW,YAAY;AAG1BC,kBAAAA,MAAI,WAAW;AAAA,MACb,KAAK;AAAA,IACX,CAAK;AACD,WAAO;AAAA,EACR;AACD,SAAO;AACT;;"}