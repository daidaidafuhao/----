{"version":3,"file":"login.js","sources":["common/api/login.js"],"sourcesContent":["import { getWechatLoginState, wechatLogin } from './wechat.js';\r\nimport store from '../../store/index.js';\r\n\r\n// 检查登录状态并处理未登录情况\r\nexport function checkLoginAndRedirect() {\r\n  const loginState = getWechatLoginState();\r\n  if (!loginState.isLoggedIn) {\r\n    // 未登录，跳转到登录页面\r\n    // 使用绝对路径（确保以/开头）\r\n    uni.redirectTo({\r\n      url: '/pages/login/index'\r\n    });\r\n    return false;\r\n  }\r\n  return true;\r\n}\r\n\r\n// 执行登录流程\r\nexport function doLogin() {\r\n  return new Promise((resolve, reject) => {\r\n    uni.showLoading({\r\n      title: '登录中...'\r\n    });\r\n    \r\n    wechatLogin()\r\n      .then(res => {\r\n        uni.hideLoading();\r\n        uni.showToast({\r\n          title: '登录成功',\r\n          icon: 'success'\r\n        });\r\n        \r\n        // 保存登录状态到Vuex\r\n        store.commit('login', 'weixin');\r\n        store.commit('setOpenid', res.openid);\r\n        \r\n        // 保存管理员状态到Vuex\r\n        if (res.isAdmin) {\r\n          store.commit('setAdmin', true);\r\n          \r\n          // 管理员用户跳转到管理页面\r\n          uni.reLaunch({\r\n            url: '/pages/admin/index'\r\n          });\r\n        } else {\r\n          store.commit('setAdmin', false);\r\n          \r\n          // 普通用户跳转到数据录入页面\r\n          uni.switchTab({\r\n            url: '/pages/data-entry/index'\r\n          });\r\n        }\r\n        \r\n        resolve(res);\r\n      })\r\n      .catch(err => {\r\n        uni.hideLoading();\r\n        uni.showToast({\r\n          title: '登录失败: ' + (err.message || '未知错误'),\r\n          icon: 'none'\r\n        });\r\n        reject(err);\r\n      });\r\n  });\r\n}\r\n\r\nexport default {\r\n  checkLoginAndRedirect,\r\n  doLogin\r\n}; "],"names":["getWechatLoginState","uni"],"mappings":";;;;AAIO,SAAS,wBAAwB;AACtC,QAAM,aAAaA,kBAAAA;AACnB,MAAI,CAAC,WAAW,YAAY;AAG1BC,kBAAAA,MAAI,WAAW;AAAA,MACb,KAAK;AAAA,IACX,CAAK;AACD,WAAO;AAAA,EACR;AACD,SAAO;AACT;;"}